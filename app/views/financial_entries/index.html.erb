<div class="financial-container">
  <!-- Header com estatísticas -->
  <div class="stats-header">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= number_to_currency(@expected_result) %></div>
          <div class="stat-label">Resultado Previsto</div>
        </div>
      </div>
      
      <div class="stat-card active">
        <div class="stat-icon">
          <i class="fas fa-arrow-up"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= number_to_currency(@receivables_total) %></div>
          <div class="stat-label">Recebimentos</div>
          <div class="stat-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: <%= @receivable_progress %>%"></div>
            </div>
            <small>
              <%= number_to_percentage(@receivable_progress, precision: 1) %> recebido
              (<%= number_to_currency(@receivables_paid) %>)
            </small>
          </div>
        </div>
      </div>
      
      <div class="stat-card warning">
        <div class="stat-icon">
          <i class="fas fa-arrow-down"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= number_to_currency(@payables_total) %></div>
          <div class="stat-label">Despesas</div>
          <div class="stat-progress">
            <div class="progress-bar">
              <div class="progress-fill warning" style="width: <%= @payable_progress %>%"></div>
            </div>
            <small>
              <%= number_to_percentage(@payable_progress, precision: 1) %> pago
              (<%= number_to_currency(@payables_paid) %>)
            </small>
          </div>
        </div>
      </div>
      
      <div class="stat-card success">
        <div class="stat-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= @financial_entries.count %></div>
          <div class="stat-label">Transações</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra de ferramentas -->
  <div class="toolbar">
    <div class="toolbar-left">
      <h1 class="page-title">
        <i class="fas fa-money-bill-wave"></i>
        Gestão Financeira
      </h1>
    </div>
    
    <div class="toolbar-right">
      <% active_filters_count = [params[:q], params[:payment_state], params[:start_date], params[:end_date]].count(&:present?) %>
      <!-- Botões Recebimentos / Despesas -->
      <div class="toggle-type">
        <%= link_to 'Recebimentos', financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: 'receivable', client_id: params[:client_id], page: params[:page], per_page: params[:per_page]), class: "btn btn-segment receivables #{params[:type] == 'payable' ? '' : 'active'}" %>
        <%= link_to 'Despesas', financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: 'payable', client_id: params[:client_id], page: params[:page], per_page: params[:per_page]), class: "btn btn-segment payables #{params[:type] == 'payable' ? 'active' : ''}" %>
      </div>
      
      <!-- Busca rápida -->
      <%= form_with url: financial_entries_path, method: :get, local: true, html: { class: 'search-box desktop-only' } do %>
        <%= hidden_field_tag :month, @selected_month.strftime('%Y-%m') %>
        <%= hidden_field_tag :type, params[:type] %>
        <%= hidden_field_tag :payment_state, params[:payment_state] %>
        <%= text_field_tag :q, params[:q], class: 'form-control search-input', placeholder: 'Buscar por pedido, cliente ou descrição' %>
      <% end %>

      <!-- Busca para Mobile -->
      <%= form_with url: financial_entries_path, method: :get, local: true, html: { class: 'search-box mobile-only' } do %>
        <%= hidden_field_tag :month, @selected_month.strftime('%Y-%m') %>
        <%= hidden_field_tag :type, params[:type] %>
        <%= hidden_field_tag :payment_state, params[:payment_state] %>
        <%= text_field_tag :q, params[:q], class: 'form-control search-input', placeholder: 'Buscar por pedido, cliente ou descrição' %>
      <% end %>

      <!-- Filtro por Empresa (Mobile) -->
      <div class="company-filter mobile-only">
        <% current_company = params[:company] %>
        <%= link_to 'Todas', financial_entries_path(request.query_parameters.except(:company).merge(month: @selected_month.strftime('%Y-%m'))), class: "btn btn-light btn-sm #{'active' if current_company.blank?}" %>
        <%= link_to 'Fontes Energia', financial_entries_path(request.query_parameters.merge(company: 'Fontes Energia', month: @selected_month.strftime('%Y-%m'))), class: "btn btn-sm company-pill fontes #{'active' if current_company == 'Fontes Energia'}" %>
        <%= link_to 'Radial Equipamentos', financial_entries_path(request.query_parameters.merge(company: 'Radial Equipamentos', month: @selected_month.strftime('%Y-%m'))), class: "btn btn-sm company-pill radial #{'active' if current_company == 'Radial Equipamentos'}" %>
      </div>

      <!-- Filtro por Empresa -->
      <div class="company-filter desktop-only">
        <% current_company = params[:company] %>
        <%= link_to 'Todas', financial_entries_path(request.query_parameters.except(:company).merge(month: @selected_month.strftime('%Y-%m'))), class: "btn btn-light btn-sm #{'active' if current_company.blank?}" %>
        <%= link_to 'Fontes Energia', financial_entries_path(request.query_parameters.merge(company: 'Fontes Energia', month: @selected_month.strftime('%Y-%m'))), class: "btn btn-sm company-pill fontes #{'active' if current_company == 'Fontes Energia'}" %>
        <%= link_to 'Radial Equipamentos', financial_entries_path(request.query_parameters.merge(company: 'Radial Equipamentos', month: @selected_month.strftime('%Y-%m'))), class: "btn btn-sm company-pill radial #{'active' if current_company == 'Radial Equipamentos'}" %>
      </div>

      <!-- Nova transação à esquerda do layout (alinhada com os botões) -->
      <%= link_to new_financial_entry_path(entry_type: params[:type], client_id: params[:client_id]), class: "btn btn-primary new-transaction-left" do %>
        <i class="fas fa-plus"></i>
        Nova transação
      <% end %>
      <!-- Seletor de Mês -->
      <div class="month-selector">
        <%= link_to financial_entries_path(month: (@selected_month - 1.month).strftime('%Y-%m'), type: params[:type], q: params[:q], payment_state: params[:payment_state], page: params[:page], per_page: params[:per_page]), class: "btn btn-outline-secondary btn-sm" do %>
          <i class="fas fa-chevron-left"></i>
        <% end %>
        <span class="current-month"><%= l(@selected_month, format: '%B de %Y').capitalize %></span>
        <%= link_to financial_entries_path(month: (@selected_month + 1.month).strftime('%Y-%m'), type: params[:type], q: params[:q], payment_state: params[:payment_state], page: params[:page], per_page: params[:per_page]), class: "btn btn-outline-secondary btn-sm" do %>
          <i class="fas fa-chevron-right"></i>
        <% end %>
      </div>
      <!-- Filtros rápidos de situação -->
      <div class="status-quick">
        <% cur = params[:payment_state] %>
        <%= link_to 'Todos', financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: params[:type], q: params[:q]), class: "btn btn-light btn-sm #{'active' if cur.blank?}" %>
        <%= link_to 'Pagas', financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: params[:type], q: params[:q], payment_state: (cur == 'paid' ? nil : 'paid')), class: "btn btn-light btn-sm #{'active' if cur == 'paid'}" %>
        <%= link_to 'Não pagas', financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: params[:type], q: params[:q], payment_state: (cur == 'not_paid' ? nil : 'not_paid')), class: "btn btn-light btn-sm #{'active' if cur == 'not_paid'}" %>
        <%= link_to 'A vencer hoje', financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: params[:type], q: params[:q], payment_state: (cur == 'due_today' ? nil : 'due_today')), class: "btn btn-light btn-sm #{'active' if cur == 'due_today'}" %>
        <%= link_to 'Vencidas', financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: params[:type], q: params[:q], payment_state: (cur == 'overdue' ? nil : 'overdue')), class: "btn btn-light btn-sm #{'active' if cur == 'overdue'}" %>
      </div>

      <!-- Filtros (menu popup estilo dropdown) -->
      <button type="button" id="filterBtn" class="btn btn-outline-secondary filter-toggle-btn" onclick="toggleFilterMenu(event)">
        <i class="fas fa-sliders-h"></i>
        Filtrar
        <% if active_filters_count > 0 %>
          <span class="filter-badge"><%= active_filters_count %></span>
        <% end %>
      </button>

      <!-- Popup de filtros -->
      <div id="filterMenu" class="filter-menu" style="display:none;">
        <div class="filter-menu-header">
          <%= link_to 'Limpar', financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: params[:type]), class: 'btn btn-link btn-sm filter-clear' %>
          <span class="filter-title">Filtros</span>
          <button class="btn btn-primary btn-sm filter-done" onclick="submitFilterForm()">Concluído</button>
        </div>
        <%= form_with url: financial_entries_path, method: :get, local: true, html: { id: 'filterForm' } do |f| %>
          <%= hidden_field_tag :month, @selected_month.strftime('%Y-%m') %>
          <%= hidden_field_tag :type, params[:type] %>
          <div class="filter-item">
            <label class="filter-check">
              <input type="checkbox" id="enableDate" onchange="toggleDateFields()" <%= (params[:start_date].present? || params[:end_date].present?) ? 'checked' : '' %> >
              <span>Data</span>
            </label>
            <div class="filter-controls" id="dateControls">
              <%= date_field_tag :start_date, params[:start_date], class: 'form-control', placeholder: 'Início' %>
              <%= date_field_tag :end_date, params[:end_date], class: 'form-control', placeholder: 'Fim' %>
            </div>
          </div>
          <div class="filter-item">
            <label class="filter-check">
              <input type="checkbox" id="enableStatus" onchange="toggleStatusField()" <%= params[:payment_state].present? ? 'checked' : '' %> >
              <span>Situação do pagamento</span>
            </label>
            <div class="filter-controls" id="statusControls">
              <%= select_tag :payment_state, options_for_select([["Todos", nil], ["Pago", 'paid'], ["Não pagas", 'not_paid'], ["A vencer hoje", 'due_today'], ["Vencidas (Em atraso)", 'overdue']], params[:payment_state]), class: 'form-control' %>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Exportações -->
      <div class="filters-dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-file-csv"></i>
          Exportar
        </button>
        <ul class="dropdown-menu">
          <li>
            <%= link_to "Detalhado (CSV)", financial_entries_path(format: :csv, month: @selected_month.strftime('%Y-%m'), type: params[:type], q: params[:q], payment_state: params[:payment_state]), class: "dropdown-item" %>
          </li>
        </ul>
      </div>
      
    </div>
  </div>



  <!-- Tabela de Transações -->
  <div class="table-container">
    <div class="table-responsive">
      <table class="table table-hover financial-table compact">
        <thead>
          <tr>
            <th class="col-date">DATA</th>
            <th class="col-desc">DESCRIÇÃO</th>
            <th class="col-amount">VALOR</th>
            <th class="col-paid">PAGO?</th>
            <th class="col-client">CLIENTE</th>
            <th class="col-ref">REFERÊNCIA</th>
            <th class="col-actions">AÇÕES</th>
          </tr>
        </thead>
        <tbody>
          <% @financial_entries.each do |entry| %>
            <tr class="financial-row <%= 'overdue' if entry.is_overdue? %>">
              <!-- Data -->
              <td class="due-date-cell">
                <div class="date-info">
                  <div class="date-row"><span class="date-label">Vencimento:</span> <span class="date-value"><%= entry.formatted_due_date %></span></div>
                  <div class="date-row">
                    <span class="date-label">Pagamento:</span>
                    <% if entry.has_paid_date? %>
                      <span class="date-value paid"><%= entry.formatted_paid_date %></span>
                    <% else %>
                      <span class="date-value unpaid">—</span>
                    <% end %>
                  </div>
                  <% if entry.is_overdue? %>
                    <div class="overdue-alert inline">
                      <small class="text-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        Vencido há <%= entry.days_overdue %> dias
                      </small>
                    </div>
                  <% end %>
                </div>
              </td>
              
              <!-- Descrição -->
              <td class="description-cell">
                <div class="description-content">
                  <strong><%= entry.description %></strong>
                  <div class="entry-company">
                    <% if entry.company.present? %>
                      <span class="company-badge <%= entry.company == 'Fontes Energia' ? 'company-fontes' : 'company-aradial' %>"><%= entry.company %></span>
                    <% else %>
                      <span class="company-badge" style="background:#f3f4f6; color:#374151; border:1px solid #e5e7eb;">Sem empresa</span>
                    <% end %>
                    <span class="entry-pill <%= entry.entry_type == 'receivable' ? 'pill-receivable' : 'pill-payable' %>">
                      <%= entry.entry_type == 'receivable' ? 'Recebimento' : 'Despesa' %>
                    </span>
                  </div>
                </div>
              </td>
              
              <!-- Valor -->
              <td class="amount-cell">
                <div class="amount-value <%= entry.entry_type == 'receivable' ? 'text-success' : 'text-danger' %>">
                  <strong><%= number_to_currency(entry.amount) %></strong>
                </div>
              </td>

              <!-- Status Pago? -->
              <td class="status-cell">
                <% if entry.is_paid? %>
                  <%= button_to update_status_financial_entry_path(entry, month: @selected_month.strftime('%Y-%m'), type: params[:type]), 
                      method: :patch, 
                      class: "status-toggle paid", 
                      title: 'Pago – clique para marcar como pendente',
                      role: 'switch',
                      'aria-checked': true,
                      form: { style: 'display: inline;' } do %>
                    <div class="toggle-switch paid">
                      <div class="toggle-slider active"></div>
                    </div>
                    <span class="status-text">
                      PAGO
                    </span>
                  <% end %>
                <% else %>
                  <button type="button" 
                          class="status-toggle <%= entry.is_overdue? ? 'overdue' : 'pending' %>" 
                          title="Pendente – clique para registrar pagamento"
                          role="switch" aria-checked="false"
                          onclick="openPaymentModal('<%= entry.id %>', '<%= entry.description %>', '<%= entry.formatted_due_date %>')">
                    <div class="toggle-switch <%= 'overdue' if entry.is_overdue? %>">
                      <div class="toggle-slider"></div>
                    </div>
                    <span class="status-text">
                      PENDENTE
                    </span>
                  </button>
                <% end %>
              </td>

              <!-- Cliente (Recebido de) -->
              <td class="client-cell">
                <% if entry.client %>
                  <%= link_to entry.client.display_name, client_path(entry.client), class: "reference-link" %>
                <% else %>
                  <span class="text-muted">N/A</span>
                <% end %>
              </td>
              
              <!-- Referência -->
              <td class="reference-cell">
                <% if entry.reference %>
                  <% begin %>
                    <% if entry.reference.is_a?(RentalBillingPeriod) %>
                      <%= link_to 'Locação', rental_rental_billing_period_path(entry.reference.rental, entry.reference), class: "reference-link" %>
                    <% else %>
                      <%= link_to (entry.reference.model_name.human rescue entry.reference.class.name), polymorphic_path(entry.reference), class: "reference-link" %>
                    <% end %>
                  <% rescue NoMethodError, ActionController::UrlGenerationError %>
                    <span class="reference-text"><%= (entry.reference.model_name.human rescue entry.reference.class.name) %></span>
                  <% end %>
                <% else %>
                  <span class="text-muted">N/A</span>
                <% end %>
              </td>

              <!-- Ações -->
              <td class="actions-cell">
                <div class="action-buttons">
                  <%= link_to edit_financial_entry_path(entry), class: "btn btn-sm btn-outline-primary", title: "Editar" do %>
                    <i class="fas fa-edit"></i>
                  <% end %>
                  
                  <%= link_to financial_entry_path(entry), class: "btn btn-sm btn-outline-info", title: "Visualizar" do %>
                    <i class="fas fa-eye"></i>
                  <% end %>
                  
                  <%= button_to financial_entry_path(entry), 
                      method: :delete, 
                      data: { confirm: "Tem certeza que deseja remover esta transação?" },
                      class: "btn btn-sm btn-outline-danger",
                      title: "Remover",
                      form: { style: 'display: inline;', onsubmit: "return confirm('Tem certeza que deseja remover esta transação?')" } do %>
                    <i class="fas fa-trash"></i>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
          <% if @financial_entries.empty? %>
            <tr>
              <td colspan="6" class="text-center py-5">
                <div class="empty-state">
                  <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                  <h5 class="text-muted">Nenhuma transação encontrada</h5>
                  <p class="text-muted">Não há transações para o mês selecionado.</p>
                  <%= link_to new_financial_entry_path, class: "btn btn-primary" do %>
                    <i class="fas fa-plus"></i>
                    Criar Primeira Transação
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para Data de Pagamento -->
<div id="paymentModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Confirmar Pagamento</h3>
      <button type="button" class="modal-close" onclick="closePaymentModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="payment-info">
        <p><strong>Descrição:</strong> <span id="modalDescription"></span></p>
        <p><strong>Vencimento:</strong> <span id="modalDueDate"></span></p>
      </div>
      
      <div class="form-group">
        <label for="paidDate" class="form-label">Data do Pagamento</label>
        <input type="date" id="paidDate" class="form-control" value="<%= Date.current.strftime('%Y-%m-%d') %>" required>
        <small class="form-help">Selecione a data efetiva do pagamento</small>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancelar</button>
      <button type="button" class="btn btn-success" onclick="confirmPayment()">Confirmar Pagamento</button>
    </div>
  </div>
</div>

<!-- Paginação -->
<% if @total_pages && @total_pages > 1 %>
  <div class="pagination-container">
    <nav>
      <ul class="pagination">
        <li class="page-item <%= 'disabled' if @page <= 1 %>"><%= link_to '«', financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: params[:type], client_id: params[:client_id], page: (@page - 1), per_page: @per_page, start_date: params[:start_date], end_date: params[:end_date], payment_state: params[:payment_state], amount_min: params[:amount_min], amount_max: params[:amount_max]), class: 'page-link' %></li>
        <% ([1, @page-2, @page-1, @page, @page+1, @page+2, @total_pages].uniq.select { |p| p > 0 && p <= @total_pages }).each do |p| %>
          <% if p == @page %>
            <li class="page-item active"><a class="page-link"><%= p %></a></li>
          <% else %>
            <li class="page-item"><%= link_to p, financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: params[:type], client_id: params[:client_id], page: p, per_page: @per_page, start_date: params[:start_date], end_date: params[:end_date], payment_state: params[:payment_state], amount_min: params[:amount_min], amount_max: params[:amount_max]), class: 'page-link' %></li>
          <% end %>
        <% end %>
        <li class="page-item <%= 'disabled' if @page >= @total_pages %>"><%= link_to '»', financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: params[:type], client_id: params[:client_id], page: (@page + 1), per_page: @per_page, start_date: params[:start_date], end_date: params[:end_date], payment_state: params[:payment_state], amount_min: params[:amount_min], amount_max: params[:amount_max]), class: 'page-link' %></li>
      </ul>
    </nav>
  </div>
<% end %>

<!-- Removido: chips de filtros e somatório por cliente para simplificação da tela -->

<!-- Formulário oculto para envio -->
<form id="paymentForm" method="post" style="display: none;">
  <input type="hidden" name="_method" value="patch">
  <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
  <input type="hidden" id="paymentEntryId" name="entry_id">
  <input type="hidden" id="paymentDate" name="paid_date">
</form>

<style>
.financial-container {
  padding: 20px;
  background: #f8f9fa;
  min-height: 100vh;
}

.stats-header {
  margin-bottom: 30px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.stat-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  transition: transform 0.2s;
}

.stat-card:hover {
  transform: translateY(-2px);
}

.stat-card.active {
  border-left: 4px solid #28a745;
}

.stat-card.warning {
  border-left: 4px solid #ffc107;
}

.stat-card.success {
  border-left: 4px solid #17a2b8;
}

.stat-icon {
  font-size: 2rem;
  margin-right: 15px;
  color: #6c757d;
}

.stat-content {
  flex: 1;
}

.stat-number {
  font-size: 1.5rem;
  font-weight: bold;
  color: #333;
}

.stat-label {
  font-size: 0.9rem;
  color: #6c757d;
  margin-top: 5px;
}

.stat-progress {
  margin-top: 10px;
}

.progress-bar {
  width: 100%;
  height: 6px;
  background: #e9ecef;
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 5px;
}

.progress-fill {
  height: 100%;
  background: #28a745;
  transition: width 0.3s ease;
}

.progress-fill.warning {
  background: #ffc107;
}

.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  background: white;
  padding: 15px 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  position: sticky;
  top: 0; /* fixa no topo ao rolar */
  z-index: 100;
}

.page-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #333;
  margin: 0;
}

.page-title i {
  margin-right: 10px;
  color: #007bff;
}

.toolbar-right {
  display: flex;
  align-items: center;
  gap: 15px;
}
.search-box { display: inline-flex; }
.search-input { min-width: 260px; }
.status-quick { display: flex; gap: 6px; align-items: center; }
.status-quick .btn.active { border-color: #0d6efd; color: #0d6efd; background: #e7f1ff; }
.new-transaction-left { margin-left: 10px; }
.filter-toggle-btn { display: none; }
.desktop-only { display: block; }
.company-filter { display: flex; gap: 6px; align-items: center; }
.company-pill { border: 1px solid transparent; border-radius: 999px; padding: 4px 10px; font-weight: 600; }
.company-pill.fontes { color: #047857; border-color: #059669; background: #ecfdf5; }
.company-pill.fontes.active { background: #059669; color: #fff; }
.company-pill.radial { color: #4338ca; border-color: #6366f1; background: #eef2ff; }
.company-pill.radial.active { background: #6366f1; color: #fff; }
.mobile-only { display: none; }

.month-selector {
  display: flex;
  align-items: center;
  gap: 10px;
}

.current-month {
  font-weight: 600;
  color: #495057;
  min-width: 120px;
  text-align: center;
}



.table-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  overflow: hidden;
}

.financial-table {
  margin: 0;
}

/* Colunas mais compactas */
.financial-table.compact .col-date { width: 22%; }
.financial-table.compact .col-desc { width: 28%; }
.financial-table.compact .col-amount { width: 12%; text-align: right; }
.financial-table.compact .col-paid { width: 10%; text-align: center; }
.financial-table.compact .col-client { width: 14%; }
.financial-table.compact .col-ref { width: 10%; }
.financial-table.compact .col-actions { width: 4%; text-align: right; }

.financial-table th {
  background: #f8f9fa;
  border: none;
  padding: 15px;
  font-weight: 600;
  color: #495057;
}

.financial-table td {
  padding: 10px 12px;
  border: none;
  border-bottom: 1px solid #e9ecef;
  vertical-align: middle;
}

.financial-row:hover {
  background: #f8f9fa;
}

.financial-row.overdue {
  background: #fff5f5;
  border-left: 4px solid #dc3545;
}

.action-buttons {
  display: flex;
  gap: 5px;
}

.date-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.date-row { display: flex; gap: 6px; align-items: center; font-size: 0.95rem; }
.date-label { color: #6b7280; font-weight: 600; }
.date-value { color: #374151; font-weight: 500; }
.date-value.paid { color: #059669; }
.date-value.unpaid { color: #9ca3af; }

.description-content {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.entry-type { margin-top: 2px; }

.company-badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 600; margin-top: 4px; }
.company-fontes { background: #ecfdf5; color: #047857; border: 1px solid #059669; }
.company-aradial { background: #eef2ff; color: #4338ca; border: 1px solid #6366f1; }

.entry-pill {
  display: inline-block;
  margin-left: 6px;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
}
.pill-receivable { background: #e6f9f1; color: #0f766e; border: 1px solid #14b8a6; }
.pill-payable { background: #ffe4e6; color: #be123c; border: 1px solid #f43f5e; }

.amount-value {
  font-size: 1.1rem;
  font-weight: 600;
}

.reference-link {
  color: #007bff;
  text-decoration: none;
  font-weight: 500;
}

.reference-link:hover {
  text-decoration: underline;
}

.reference-text {
  color: #6c757d;
  font-weight: 500;
}

.status-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  justify-content: center; /* centraliza quando não há texto */
  text-decoration: none;
  color: inherit;
  padding: 2px 4px; /* formato compacto, abraça o switch */
  border-radius: 999px; /* pílula externa */
  transition: all 0.3s ease;
  border: 2px solid transparent;
  min-width: unset; /* sem largura mínima */
}

.status-toggle.pending {
  background: #fff3cd;
  border-color: #ffc107;
  color: #856404;
}

.status-toggle.overdue {
  background: #ffe5e5;
  border-color: #ef4444;
  color: #991b1b;
}

.status-toggle.pending:hover {
  background: #ffeaa7;
  border-color: #f39c12;
}

.status-toggle.paid {
  background: #d4edda;
  border-color: #28a745;
  color: #155724;
}

.status-toggle.paid:hover {
  background: #c3e6cb;
  border-color: #20c997;
}

.toggle-switch {
  width: 32px; /* compacto */
  height: 18px; /* compacto */
  background: #e9ecef;
  border-radius: 999px;
  position: relative;
  transition: background 0.3s ease;
  border: 2px solid #dee2e6;
}

.toggle-switch.paid {
  background: #28a745;
  border-color: #20c997;
}

.toggle-slider {
  width: 14px;
  height: 14px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 1px;
  left: 1px;
  transition: transform 0.3s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-slider.active {
  transform: translateX(14px); /* ajusta ao novo tamanho */
}

.status-text { display: none; }

.overdue-alert {
  background: rgba(220, 53, 69, 0.1);
  border: 1px solid rgba(220, 53, 69, 0.3);
  border-radius: 4px;
  padding: 2px 6px; /* menor */
}
.overdue-alert.inline { display: inline-block; margin-top: 4px; }

.overdue-alert small {
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 4px;
}

.empty-state {
  padding: 40px 20px;
  text-align: center;
}

.empty-state i {
  margin-bottom: 15px;
}

.pagination-container {
  display: flex;
  justify-content: center;
  margin: 20px 0;
}

.sum-by-client {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  padding: 16px 20px;
  margin-top: 20px;
}

.chips { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin: 10px 0; }
.chip { background: #eef2f7; border: 1px solid #d9e2ef; color: #334155; padding: 6px 10px; border-radius: 999px; font-size: 0.85rem; display: inline-flex; gap: 8px; align-items: center; }
.chip-close { color: #6b7280; text-decoration: none; font-weight: 700; }
.chip-close:hover { color: #ef4444; }

@media (max-width: 768px) {
  .toolbar {
    flex-direction: column;
    gap: 15px;
    top: 0;
  }
  
  .toolbar-right {
    flex-wrap: wrap;
    justify-content: center;
  }
  .mobile-only { display: block; width: 100%; }
  .search-box.mobile-only { order: 3; }
  .search-input { width: 100%; min-width: 0; }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .month-selector {
    flex-direction: column;
    gap: 5px;
  }
  .filter-toggle-btn { display: inline-flex; }
  .desktop-only { display: none; }
}

/* Modal Styles */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

/* Filter popup */
.filter-menu { position: absolute; right: 20px; top: 100%; margin-top: 8px; width: 360px; background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); padding: 12px; z-index: 1200; }
.filter-menu-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 8px 10px; border-bottom: 1px solid #e5e7eb; margin-bottom: 10px; }
.filter-title { font-weight: 600; }
.filter-item { padding: 8px 4px; border-bottom: 1px solid #f1f3f5; }
.filter-item:last-child { border-bottom: none; }
.filter-check { display: flex; align-items: center; gap: 8px; font-weight: 600; color: #374151; }
.filter-controls { display: flex; gap: 8px; margin-top: 8px; }
.filter-menu .form-control { flex: 1; }
.filter-clear { color: #6b7280 !important; }
.filter-done { padding: 6px 10px; }

.modal-content {
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #e5e7eb;
}

.modal-header h3 {
  margin: 0;
  color: #1f2937;
  font-size: 1.25rem;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #6b7280;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s;
}

.modal-close:hover {
  background: #f3f4f6;
}
/* Painel lateral de filtros */
.side-filter-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; z-index: 1100; }
.side-filter-panel { position: fixed; top: 0; right: -340px; width: 320px; height: 100vh; background: #fff; box-shadow: -4px 0 12px rgba(0,0,0,0.1); z-index: 1110; transition: right .25s ease; display: flex; flex-direction: column; }
.side-filter-header { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid #e5e7eb; }
.side-filter-body { padding: 16px; overflow-y: auto; }
.side-filter-close { background: none; border: none; font-size: 1.5rem; color: #6b7280; }
.side-filters-open #sideFilterOverlay { display: block; }
.side-filters-open #sideFilterPanel { right: 0; }

.modal-body {
  padding: 20px;
}

.payment-info {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
}

.payment-info p {
  margin: 0 0 8px 0;
  color: #374151;
}

.payment-info p:last-child {
  margin-bottom: 0;
}

.modal-footer {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  padding: 20px;
  border-top: 1px solid #e5e7eb;
}

/* Paid Date Styles */
.paid-date-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.payment-status {
  display: flex;
  align-items: center;
  gap: 4px;
}

.no-payment {
  text-align: center;
  color: #9ca3af;
}

/* Form Controls */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #374151;
}

.form-control {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  font-size: 1rem;
  transition: border-color 0.3s;
}

.form-control:focus {
  outline: none;
  border-color: #3b82f6;
}

.form-help {
  display: block;
  margin-top: 4px;
  font-size: 0.875rem;
  color: #6b7280;
}

.toggle-type {
  display: inline-flex;
  gap: 10px; /* separação entre os botões */
  background: transparent;
}

.btn-segment {
  padding: 8px 16px;
  border-radius: 999px; /* formato pill */
  font-weight: 600;
  transition: all .2s ease;
  line-height: 1.2;
}

/* Recebimentos: verde */
.btn-segment.receivables {
  background: #ffffff;
  color: #059669; /* verde 600 */
  border: 1px solid #059669;
}
.btn-segment.receivables:hover { filter: brightness(0.98); }
.btn-segment.receivables.active {
  background: #10b981; /* verde 500 */
  color: #ffffff;
  border-color: #10b981;
}

/* Despesas: vermelho */
.btn-segment.payables {
  background: #ffffff;
  color: #dc2626; /* vermelho 600 */
  border: 1px solid #dc2626;
}
.btn-segment.payables:hover { filter: brightness(0.98); }
.btn-segment.payables.active {
  background: #ef4444; /* vermelho 500 */
  color: #ffffff;
  border-color: #ef4444;
}

.filter-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: #ef4444;
  color: #fff;
  font-size: 0.75rem;
  font-weight: 700;
  border-radius: 999px;
  padding: 2px 6px;
  margin-left: 6px;
}
</style>

<script>
let currentEntryId = null;

function openPaymentModal(entryId, description, dueDate) {
  currentEntryId = entryId;
  document.getElementById('modalDescription').textContent = description;
  document.getElementById('modalDueDate').textContent = dueDate;
  document.getElementById('paymentModal').style.display = 'flex';
  document.getElementById('paidDate').focus();
}

function closePaymentModal() {
  document.getElementById('paymentModal').style.display = 'none';
  currentEntryId = null;
}

function confirmPayment() {
  const paidDate = document.getElementById('paidDate').value;
  
  if (!paidDate) {
    alert('Por favor, selecione uma data de pagamento.');
    return;
  }
  
  // Configurar o formulário
  const form = document.getElementById('paymentForm');
  form.action = `/financial_entries/${currentEntryId}/update_status?month=<%= @selected_month.strftime('%Y-%m') %>&type=<%= params[:type] %>`;
  
  document.getElementById('paymentEntryId').value = currentEntryId;
  document.getElementById('paymentDate').value = paidDate;
  
  // Enviar o formulário
  form.submit();
}

// Fechar modal ao clicar fora
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal-overlay')) {
    closePaymentModal();
  }
});

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closePaymentModal();
  }
});
</script>
<script>
function openSideFilters() { document.body.classList.add('side-filters-open'); }
function closeSideFilters() { document.body.classList.remove('side-filters-open'); }

// Popup de filtros
function toggleFilterMenu(event) {
  event.stopPropagation();
  const menu = document.getElementById('filterMenu');
  menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
  // Inicializa estados dos controles conforme checkboxes
  toggleDateFields();
  toggleStatusField();
}

function submitFilterForm() {
  document.getElementById('filterForm').submit();
}

function toggleDateFields() {
  const enabled = document.getElementById('enableDate').checked;
  document.getElementById('dateControls').style.display = enabled ? 'flex' : 'none';
  if (!enabled) {
    // Limpa campos ao desabilitar
    const url = new URL(window.location.href);
    url.searchParams.delete('start_date');
    url.searchParams.delete('end_date');
  }
}

function toggleStatusField() {
  const enabled = document.getElementById('enableStatus').checked;
  document.getElementById('statusControls').style.display = enabled ? 'flex' : 'none';
  if (!enabled) {
    const select = document.querySelector('#statusControls select');
    if (select) select.value = '';
  }
}

// Fecha o popup clicando fora
document.addEventListener('click', function(e) {
  const menu = document.getElementById('filterMenu');
  const btn = document.getElementById('filterBtn');
  if (!menu) return;
  if (menu.style.display === 'block' && !menu.contains(e.target) && !btn.contains(e.target)) {
    menu.style.display = 'none';
  }
});
</script>
