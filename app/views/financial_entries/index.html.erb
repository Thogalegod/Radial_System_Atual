<div class="financial-container">
  <!-- Header com estatísticas -->
  <div class="stats-header">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <i class="fas fa-dollar-sign"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= number_to_currency(@expected_result) %></div>
          <div class="stat-label">Resultado Previsto</div>
        </div>
      </div>
      
      <div class="stat-card active">
        <div class="stat-icon">
          <i class="fas fa-arrow-up"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= number_to_currency(@receivables_total) %></div>
          <div class="stat-label">Recebimentos</div>
          <div class="stat-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: <%= @receivable_progress %>%"></div>
            </div>
            <small><%= number_to_percentage(@receivable_progress, precision: 1) %> recebido</small>
          </div>
        </div>
      </div>
      
      <div class="stat-card warning">
        <div class="stat-icon">
          <i class="fas fa-arrow-down"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= number_to_currency(@payables_total) %></div>
          <div class="stat-label">Despesas</div>
          <div class="stat-progress">
            <div class="progress-bar">
              <div class="progress-fill warning" style="width: <%= @payable_progress %>%"></div>
            </div>
            <small><%= number_to_percentage(@payable_progress, precision: 1) %> pago</small>
          </div>
        </div>
      </div>
      
      <div class="stat-card success">
        <div class="stat-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number"><%= @financial_entries.count %></div>
          <div class="stat-label">Transações</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barra de ferramentas -->
  <div class="toolbar">
    <div class="toolbar-left">
      <h1 class="page-title">
        <i class="fas fa-money-bill-wave"></i>
        Gestão Financeira
      </h1>
    </div>
    
    <div class="toolbar-right">
      <!-- Seletor de Mês -->
      <div class="month-selector">
        <%= link_to financial_entries_path(month: (@selected_month - 1.month).strftime('%Y-%m')), class: "btn btn-outline-secondary btn-sm" do %>
          <i class="fas fa-chevron-left"></i>
        <% end %>
        <span class="current-month"><%= l(@selected_month, format: '%B de %Y').capitalize %></span>
        <%= link_to financial_entries_path(month: (@selected_month + 1.month).strftime('%Y-%m')), class: "btn btn-outline-secondary btn-sm" do %>
          <i class="fas fa-chevron-right"></i>
        <% end %>
      </div>
      
      <!-- Filtros -->
      <div class="filters-dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-filter"></i>
          Filtros
        </button>
        <ul class="dropdown-menu">
          <li><%= link_to "Todos", financial_entries_path(month: @selected_month.strftime('%Y-%m')), class: "dropdown-item" %></li>
          <li><%= link_to "Recebimentos", financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: 'receivable'), class: "dropdown-item" %></li>
          <li><%= link_to "Despesas", financial_entries_path(month: @selected_month.strftime('%Y-%m'), type: 'payable'), class: "dropdown-item" %></li>
        </ul>
      </div>
      
      <!-- Nova Transação -->
      <%= link_to new_financial_entry_path, class: "btn btn-primary" do %>
        <i class="fas fa-plus"></i>
        Nova Transação
      <% end %>
    </div>
  </div>



  <!-- Tabela de Transações -->
  <div class="table-container">
    <div class="table-responsive">
      <table class="table table-hover financial-table">
        <thead>
          <tr>
            <th>AÇÕES</th>
            <th>VENCIMENTO</th>
            <th>PAGAMENTO</th>
            <th>DESCRIÇÃO</th>
            <th>VALOR</th>
            <th>REFERÊNCIA</th>
            <th>STATUS</th>
          </tr>
        </thead>
        <tbody>
          <% @financial_entries.each do |entry| %>
            <tr class="financial-row <%= 'overdue' if entry.is_overdue? %>">
              <!-- Ações -->
              <td class="actions-cell">
                <div class="action-buttons">
                  <%= link_to edit_financial_entry_path(entry), class: "btn btn-sm btn-outline-primary", title: "Editar" do %>
                    <i class="fas fa-edit"></i>
                  <% end %>
                  
                  <%= link_to financial_entry_path(entry), class: "btn btn-sm btn-outline-info", title: "Visualizar" do %>
                    <i class="fas fa-eye"></i>
                  <% end %>
                  
                  <%= button_to financial_entry_path(entry), 
                      method: :delete, 
                      data: { confirm: "Tem certeza que deseja remover esta transação?" },
                      class: "btn btn-sm btn-outline-danger",
                      title: "Remover",
                      form: { style: 'display: inline;', onsubmit: "return confirm('Tem certeza que deseja remover esta transação?')" } do %>
                    <i class="fas fa-trash"></i>
                  <% end %>
                </div>
              </td>
              
              <!-- Data de Vencimento -->
              <td class="due-date-cell">
                <div class="date-info">
                  <div class="date-main"><%= entry.formatted_due_date %></div>
                  <% if entry.is_overdue? %>
                    <div class="overdue-alert">
                      <small class="text-danger">
                        <i class="fas fa-exclamation-circle"></i>
                        Vencido há <%= entry.days_overdue %> dias
                      </small>
                    </div>
                  <% end %>
                </div>
              </td>
              
              <!-- Data de Pagamento -->
              <td class="paid-date-cell">
                <% if entry.has_paid_date? %>
                  <div class="paid-date-info">
                    <div class="date-main text-success"><%= entry.formatted_paid_date %></div>
                    <% if entry.was_paid_on_time? %>
                      <div class="payment-status">
                        <small class="text-success">
                          <i class="fas fa-check-circle"></i>
                          No prazo
                        </small>
                      </div>
                    <% else %>
                      <div class="payment-status">
                        <small class="text-warning">
                          <i class="fas fa-clock"></i>
                          <%= pluralize(entry.days_to_pay.abs, 'dia') %> <%= entry.days_to_pay > 0 ? 'atrasado' : 'antecipado' %>
                        </small>
                      </div>
                    <% end %>
                  </div>
                <% else %>
                  <div class="no-payment">
                    <span class="text-muted">-</span>
                  </div>
                <% end %>
              </td>
              
              <!-- Descrição -->
              <td class="description-cell">
                <div class="description-content">
                  <strong><%= entry.description %></strong>
                  <div class="entry-type">
                    <span class="badge <%= entry.entry_type == 'receivable' ? 'bg-success' : 'bg-danger' %>">
                      <%= entry.entry_type == 'receivable' ? 'RECEBIMENTO' : 'DESPESA' %>
                    </span>
                  </div>
                </div>
              </td>
              
              <!-- Valor -->
              <td class="amount-cell">
                <div class="amount-value <%= entry.entry_type == 'receivable' ? 'text-success' : 'text-danger' %>">
                  <strong><%= number_to_currency(entry.amount) %></strong>
                </div>
              </td>
              
              <!-- Referência -->
              <td class="reference-cell">
                <% if entry.reference %>
                  <% begin %>
                    <% if entry.reference.is_a?(RentalBillingPeriod) %>
                      <%= link_to entry.reference.class.name, rental_rental_billing_period_path(entry.reference.rental, entry.reference), class: "reference-link" %>
                    <% else %>
                      <%= link_to entry.reference.class.name, polymorphic_path(entry.reference), class: "reference-link" %>
                    <% end %>
                  <% rescue NoMethodError, ActionController::UrlGenerationError %>
                    <span class="reference-text"><%= entry.reference.class.name %></span>
                  <% end %>
                <% else %>
                  <span class="text-muted">N/A</span>
                <% end %>
              </td>
              
              <!-- Status -->
              <td class="status-cell">
                <% if entry.is_paid? %>
                  <%= button_to update_status_financial_entry_path(entry, month: @selected_month.strftime('%Y-%m'), type: params[:type]), 
                      method: :patch, 
                      class: "status-toggle paid", 
                      form: { style: 'display: inline;' } do %>
                    <div class="toggle-switch paid">
                      <div class="toggle-slider active"></div>
                    </div>
                    <span class="status-text">
                      PAGO
                    </span>
                  <% end %>
                <% else %>
                  <button type="button" 
                          class="status-toggle pending" 
                          onclick="openPaymentModal('<%= entry.id %>', '<%= entry.description %>', '<%= entry.formatted_due_date %>')">
                    <div class="toggle-switch">
                      <div class="toggle-slider"></div>
                    </div>
                    <span class="status-text">
                      PENDENTE
                    </span>
                  </button>
                <% end %>
              </td>
            </tr>
          <% end %>
          <% if @financial_entries.empty? %>
            <tr>
              <td colspan="6" class="text-center py-5">
                <div class="empty-state">
                  <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                  <h5 class="text-muted">Nenhuma transação encontrada</h5>
                  <p class="text-muted">Não há transações para o mês selecionado.</p>
                  <%= link_to new_financial_entry_path, class: "btn btn-primary" do %>
                    <i class="fas fa-plus"></i>
                    Criar Primeira Transação
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal para Data de Pagamento -->
<div id="paymentModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Confirmar Pagamento</h3>
      <button type="button" class="modal-close" onclick="closePaymentModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="payment-info">
        <p><strong>Descrição:</strong> <span id="modalDescription"></span></p>
        <p><strong>Vencimento:</strong> <span id="modalDueDate"></span></p>
      </div>
      
      <div class="form-group">
        <label for="paidDate" class="form-label">Data do Pagamento</label>
        <input type="date" id="paidDate" class="form-control" value="<%= Date.current.strftime('%Y-%m-%d') %>" required>
        <small class="form-help">Selecione a data efetiva do pagamento</small>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">Cancelar</button>
      <button type="button" class="btn btn-success" onclick="confirmPayment()">Confirmar Pagamento</button>
    </div>
  </div>
</div>

<!-- Formulário oculto para envio -->
<form id="paymentForm" method="post" style="display: none;">
  <input type="hidden" name="_method" value="patch">
  <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
  <input type="hidden" id="paymentEntryId" name="entry_id">
  <input type="hidden" id="paymentDate" name="paid_date">
</form>

<style>
.financial-container {
  padding: 20px;
  background: #f8f9fa;
  min-height: 100vh;
}

.stats-header {
  margin-bottom: 30px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 20px;
}

.stat-card {
  background: white;
  border-radius: 12px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  transition: transform 0.2s;
}

.stat-card:hover {
  transform: translateY(-2px);
}

.stat-card.active {
  border-left: 4px solid #28a745;
}

.stat-card.warning {
  border-left: 4px solid #ffc107;
}

.stat-card.success {
  border-left: 4px solid #17a2b8;
}

.stat-icon {
  font-size: 2rem;
  margin-right: 15px;
  color: #6c757d;
}

.stat-content {
  flex: 1;
}

.stat-number {
  font-size: 1.5rem;
  font-weight: bold;
  color: #333;
}

.stat-label {
  font-size: 0.9rem;
  color: #6c757d;
  margin-top: 5px;
}

.stat-progress {
  margin-top: 10px;
}

.progress-bar {
  width: 100%;
  height: 6px;
  background: #e9ecef;
  border-radius: 3px;
  overflow: hidden;
  margin-bottom: 5px;
}

.progress-fill {
  height: 100%;
  background: #28a745;
  transition: width 0.3s ease;
}

.progress-fill.warning {
  background: #ffc107;
}

.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  background: white;
  padding: 15px 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.page-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: #333;
  margin: 0;
}

.page-title i {
  margin-right: 10px;
  color: #007bff;
}

.toolbar-right {
  display: flex;
  align-items: center;
  gap: 15px;
}

.month-selector {
  display: flex;
  align-items: center;
  gap: 10px;
}

.current-month {
  font-weight: 600;
  color: #495057;
  min-width: 120px;
  text-align: center;
}



.table-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  overflow: hidden;
}

.financial-table {
  margin: 0;
}

.financial-table th {
  background: #f8f9fa;
  border: none;
  padding: 15px;
  font-weight: 600;
  color: #495057;
}

.financial-table td {
  padding: 15px;
  border: none;
  border-bottom: 1px solid #e9ecef;
  vertical-align: middle;
}

.financial-row:hover {
  background: #f8f9fa;
}

.financial-row.overdue {
  background: #fff5f5;
  border-left: 4px solid #dc3545;
}

.action-buttons {
  display: flex;
  gap: 5px;
}

.date-info {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.date-main {
  font-weight: 500;
  color: #495057;
}

.description-content {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.entry-type {
  margin-top: 5px;
}

.amount-value {
  font-size: 1.1rem;
  font-weight: 600;
}

.reference-link {
  color: #007bff;
  text-decoration: none;
  font-weight: 500;
}

.reference-link:hover {
  text-decoration: underline;
}

.reference-text {
  color: #6c757d;
  font-weight: 500;
}

.status-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
  color: inherit;
  padding: 8px 12px;
  border-radius: 8px;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.status-toggle.pending {
  background: #fff3cd;
  border-color: #ffc107;
  color: #856404;
}

.status-toggle.pending:hover {
  background: #ffeaa7;
  border-color: #f39c12;
}

.status-toggle.paid {
  background: #d4edda;
  border-color: #28a745;
  color: #155724;
}

.status-toggle.paid:hover {
  background: #c3e6cb;
  border-color: #20c997;
}

.toggle-switch {
  width: 44px;
  height: 24px;
  background: #e9ecef;
  border-radius: 12px;
  position: relative;
  transition: background 0.3s ease;
  border: 2px solid #dee2e6;
}

.toggle-switch.paid {
  background: #28a745;
  border-color: #20c997;
}

.toggle-slider {
  width: 18px;
  height: 18px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 1px;
  left: 1px;
  transition: transform 0.3s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-slider.active {
  transform: translateX(20px);
}

.status-text {
  font-size: 0.75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  min-width: 80px;
  text-align: center;
}

.overdue-alert {
  background: rgba(220, 53, 69, 0.1);
  border: 1px solid rgba(220, 53, 69, 0.3);
  border-radius: 4px;
  padding: 4px 8px;
}

.overdue-alert small {
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 4px;
}

.empty-state {
  padding: 40px 20px;
  text-align: center;
}

.empty-state i {
  margin-bottom: 15px;
}

@media (max-width: 768px) {
  .toolbar {
    flex-direction: column;
    gap: 15px;
  }
  
  .toolbar-right {
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .month-selector {
    flex-direction: column;
    gap: 5px;
  }
}

/* Modal Styles */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #e5e7eb;
}

.modal-header h3 {
  margin: 0;
  color: #1f2937;
  font-size: 1.25rem;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #6b7280;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s;
}

.modal-close:hover {
  background: #f3f4f6;
}

.modal-body {
  padding: 20px;
}

.payment-info {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
}

.payment-info p {
  margin: 0 0 8px 0;
  color: #374151;
}

.payment-info p:last-child {
  margin-bottom: 0;
}

.modal-footer {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  padding: 20px;
  border-top: 1px solid #e5e7eb;
}

/* Paid Date Styles */
.paid-date-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.payment-status {
  display: flex;
  align-items: center;
  gap: 4px;
}

.no-payment {
  text-align: center;
  color: #9ca3af;
}

/* Form Controls */
.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #374151;
}

.form-control {
  width: 100%;
  padding: 10px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 6px;
  font-size: 1rem;
  transition: border-color 0.3s;
}

.form-control:focus {
  outline: none;
  border-color: #3b82f6;
}

.form-help {
  display: block;
  margin-top: 4px;
  font-size: 0.875rem;
  color: #6b7280;
}
</style>

<script>
let currentEntryId = null;

function openPaymentModal(entryId, description, dueDate) {
  currentEntryId = entryId;
  document.getElementById('modalDescription').textContent = description;
  document.getElementById('modalDueDate').textContent = dueDate;
  document.getElementById('paymentModal').style.display = 'flex';
  document.getElementById('paidDate').focus();
}

function closePaymentModal() {
  document.getElementById('paymentModal').style.display = 'none';
  currentEntryId = null;
}

function confirmPayment() {
  const paidDate = document.getElementById('paidDate').value;
  
  if (!paidDate) {
    alert('Por favor, selecione uma data de pagamento.');
    return;
  }
  
  // Configurar o formulário
  const form = document.getElementById('paymentForm');
  form.action = `/financial_entries/${currentEntryId}/update_status?month=<%= @selected_month.strftime('%Y-%m') %>&type=<%= params[:type] %>`;
  
  document.getElementById('paymentEntryId').value = currentEntryId;
  document.getElementById('paymentDate').value = paidDate;
  
  // Enviar o formulário
  form.submit();
}

// Fechar modal ao clicar fora
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('modal-overlay')) {
    closePaymentModal();
  }
});

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closePaymentModal();
  }
});
</script>
