<div class="content-header">
  <div class="header-content">
    <div class="breadcrumb">
      <%= link_to rentals_path, class: "breadcrumb-link" do %>
        <i class="fas fa-arrow-left"></i> Voltar para Locações
      <% end %>
    </div>
    <h1>Nova Locação</h1>
  </div>
</div>

<div class="content-body">
  <div class="form-card">
    <%= form_with(model: @rental, local: true, class: "rental-form") do |form| %>
      <% if @rental.errors.any? %>
        <div class="error-messages">
          <h3>Foram encontrados os seguintes erros:</h3>
          <ul>
            <% @rental.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <!-- Seção 1: Informações Básicas -->
      <div class="form-section">
        <div class="section-header">
          <h3><i class="fas fa-info-circle"></i> Informações da Locação</h3>
          <span class="section-badge required">Obrigatório</span>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <%= form.label :name, "Nome da Locação", class: "form-label" %>
            <%= form.text_field :name, 
                class: "form-control",
                placeholder: "Ex: Locação Transformador MT",
                required: true %>
            <small class="form-help">
              <i class="fas fa-info-circle"></i>
              Nome descritivo para identificar esta locação
            </small>
          </div>

          <div class="form-group">
            <%= form.label :client_id, "Cliente", class: "form-label" %>
            <%= form.collection_select :client_id, 
                @clients, 
                :id, 
                :name, 
                { prompt: "Selecione um cliente" },
                { class: "form-select", required: true } %>
            <small class="form-help">
              <i class="fas fa-user"></i>
              Cliente responsável por esta locação
            </small>
          </div>
        </div>

        <div class="form-group">
          <%= form.label :remessa_note, "Nota de Remessa", class: "form-label" %>
          <%= form.text_field :remessa_note, 
              class: "form-control",
              placeholder: "Ex: NFE257, SN-102030" %>
          <small class="form-help">
            <i class="fas fa-file-invoice"></i>
            Número da nota de remessa (opcional)
          </small>
        </div>

        <div class="form-group">
          <%= form.label :status, "Status", class: "form-label" %>
          <%= form.select :status, 
              [['Ativo', 'ativo'], ['Concluído', 'concluido']], 
              { selected: 'ativo' }, 
              { class: "form-select", required: true } %>
          <small class="form-help">
            <i class="fas fa-info-circle"></i>
            Status inicial da locação
          </small>
        </div>
      </div>

      <!-- Seção 2: Equipamentos -->
      <div class="form-section collapsible">
        <div class="section-header" onclick="toggleSection('equipment-section')">
          <h3><i class="fas fa-boxes"></i> Equipamentos</h3>
          <div class="section-controls">
            <span class="section-badge optional">Opcional</span>
            <i class="fas fa-chevron-down toggle-icon" id="equipment-toggle"></i>
          </div>
        </div>
        
        <div class="section-content" id="equipment-section">
          <div class="info-box">
            <p><i class="fas fa-lightbulb"></i> Você pode adicionar equipamentos agora ou depois de criar a locação.</p>
          </div>
          
          <div class="equipment-selection">
            <div class="form-group">
              <label class="form-label">Selecionar Equipamentos</label>
              
              <!-- Campo de busca -->
              <div class="search-container">
                <div class="search-input-wrapper">
                  <i class="fas fa-search search-icon"></i>
                  <input type="text" 
                         id="equipment-search" 
                         class="search-input" 
                         placeholder="Buscar equipamentos por nome, tipo ou número de série..."
                         autocomplete="off">
                  <div class="search-clear" id="search-clear" style="display: none;">
                    <i class="fas fa-times"></i>
                  </div>
                </div>
                <div class="search-info">
                  <small>Digite pelo menos 2 caracteres para buscar equipamentos por nome, tipo ou número de série</small>
                </div>
              </div>
              
              <!-- Resultados da busca -->
              <div class="equipment-grid" id="equipment-grid" style="display: none;">
                <!-- Os equipamentos aparecerão aqui quando o usuário buscar -->
              </div>
              
              <!-- Mensagem quando não há resultados -->
              <div class="no-results" id="no-results" style="display: none;">
                <div class="empty-message">
                  <i class="fas fa-search"></i>
                  <p>Nenhum equipamento encontrado com os critérios de busca.</p>
                  <small>Tente usar termos diferentes ou verifique se o equipamento está disponível.</small>
                </div>
              </div>
              
              <!-- Mensagem para digitar mais caracteres -->
              <div class="type-more" id="type-more" style="display: none;">
                <div class="empty-message">
                  <i class="fas fa-keyboard"></i>
                  <p>Digite pelo menos 2 caracteres para buscar equipamentos</p>
                  <small>Busque por nome, tipo ou número de série do equipamento</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Seção 3: Período de Faturamento -->
      <div class="form-section collapsible">
        <div class="section-header" onclick="toggleSection('billing-section')">
          <h3><i class="fas fa-calendar-alt"></i> Período de Faturamento</h3>
          <div class="section-controls">
            <span class="section-badge optional">Opcional</span>
            <i class="fas fa-chevron-down toggle-icon" id="billing-toggle"></i>
          </div>
        </div>
        
        <div class="section-content" id="billing-section">
          <div class="info-box">
            <p><i class="fas fa-lightbulb"></i> Configure o primeiro período de faturamento ou adicione depois.</p>
          </div>
          
          <div class="billing-form">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Nome do Período</label>
                <input type="text" name="billing_period[name]" class="form-control" placeholder="Ex: Janeiro 2024">
              </div>
              <div class="form-group">
                <label class="form-label">Valor (R$)</label>
                <input type="number" name="billing_period[amount]" class="form-control" placeholder="0,00" step="0.01" min="0">
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Data de Início</label>
                <input type="date" name="billing_period[start_date]" class="form-control">
              </div>
              <div class="form-group">
                <label class="form-label">Data de Fim</label>
                <input type="date" name="billing_period[end_date]" class="form-control">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <%= link_to rentals_path, class: "btn btn-outline" do %>
          <i class="fas fa-times"></i> Cancelar
        <% end %>
        <%= form.submit "Criar Locação", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>

<style>
.form-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid #e5e7eb;
  padding: 32px;
  max-width: 900px;
  margin: 0 auto;
}

.rental-form {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.form-section {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  overflow: hidden;
}

.section-header {
  background: #f9fafb;
  padding: 16px 20px;
  border-bottom: 1px solid #e5e7eb;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background-color 0.2s;
}

.section-header:hover {
  background: #f3f4f6;
}

.section-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #374151;
  display: flex;
  align-items: center;
  gap: 8px;
}

.section-controls {
  display: flex;
  align-items: center;
  gap: 12px;
}

.section-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}

.section-badge.required {
  background: #fef2f2;
  color: #dc2626;
}

.section-badge.optional {
  background: #f0f9ff;
  color: #0369a1;
}

.toggle-icon {
  color: #6b7280;
  transition: transform 0.2s;
}

.toggle-icon.rotated {
  transform: rotate(180deg);
}

.section-content {
  padding: 20px;
  display: none;
}

.section-content.active {
  display: block;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: #374151;
  font-size: 14px;
}

.form-control,
.form-select {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.2s;
  background: white;
}

.form-control:focus,
.form-select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-control::placeholder {
  color: #9ca3af;
}

.form-help {
  display: block;
  margin-top: 6px;
  font-size: 0.875rem;
  color: #6b7280;
}

.form-help i {
  margin-right: 4px;
}

.info-box {
  background: #eff6ff;
  border: 1px solid #dbeafe;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 16px;
}

.info-box p {
  margin: 0;
  color: #1e40af;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.search-container {
  margin-bottom: 16px;
}

.search-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.search-icon {
  position: absolute;
  left: 12px;
  color: #9ca3af;
  font-size: 14px;
}

.search-input {
  width: 100%;
  padding: 12px 16px 12px 40px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.2s;
  background: white;
}

.search-input:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.search-clear {
  position: absolute;
  right: 12px;
  cursor: pointer;
  color: #9ca3af;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.2s;
}

.search-clear:hover {
  color: #6b7280;
  background: #f3f4f6;
}

.search-info {
  margin-top: 6px;
  color: #6b7280;
  font-size: 12px;
}

.equipment-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 12px;
  margin-top: 12px;
}

.equipment-item {
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
}

.equipment-item:hover {
  border-color: #3b82f6;
  background: #f8fafc;
}

.equipment-item.selected {
  border-color: #3b82f6;
  background: #eff6ff;
}

.equipment-item input[type="checkbox"] {
  margin-right: 8px;
}

.equipment-name {
  font-weight: 600;
  color: #1f2937;
  margin-bottom: 4px;
}

.equipment-details {
  font-size: 12px;
  color: #6b7280;
}

.loading-message {
  text-align: center;
  padding: 20px;
  color: #6b7280;
  font-size: 14px;
}

.loading-message i {
  margin-right: 8px;
}

.empty-message,
.error-message {
  text-align: center;
  padding: 20px;
  font-size: 14px;
}

.empty-message {
  color: #6b7280;
  text-align: center;
}

.empty-message i {
  font-size: 24px;
  margin-bottom: 8px;
  color: #9ca3af;
}

.empty-message p {
  margin: 8px 0 4px 0;
  font-weight: 500;
}

.empty-message small {
  color: #9ca3af;
}

.error-message {
  color: #dc2626;
  text-align: center;
}

.billing-form {
  background: #f9fafb;
  border-radius: 8px;
  padding: 16px;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  transition: all 0.3s ease;
  border: none;
  cursor: pointer;
  font-size: 14px;
}

.btn-primary {
  background: #3b82f6;
  color: white;
}

.btn-primary:hover {
  background: #2563eb;
}

.btn-outline {
  background: transparent;
  color: #6b7280;
  border: 1px solid #d1d5db;
}

.btn-outline:hover {
  background: #f9fafb;
  color: #374151;
}

.error-messages {
  background: #fef2f2;
  border: 1px solid #fecaca;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 24px;
}

.error-messages h3 {
  color: #dc2626;
  font-size: 16px;
  margin-bottom: 12px;
}

.error-messages ul {
  margin: 0;
  padding-left: 20px;
  color: #dc2626;
}

.error-messages li {
  margin-bottom: 4px;
}

.form-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  padding-top: 24px;
  border-top: 1px solid #e5e7eb;
}

.breadcrumb {
  margin-bottom: 16px;
}

.breadcrumb-link {
  color: #6b7280;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.breadcrumb-link:hover {
  color: #374151;
}

@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .form-actions {
    flex-direction: column;
  }
  
  .equipment-grid {
    grid-template-columns: 1fr;
  }
}
</style>

<script>
function toggleSection(sectionId) {
  const section = document.getElementById(sectionId);
  const toggleIcon = document.querySelector(`#${sectionId.replace('-section', '-toggle')}`);
  
  if (section.classList.contains('active')) {
    section.classList.remove('active');
    toggleIcon.classList.remove('rotated');
  } else {
    section.classList.add('active');
    toggleIcon.classList.add('rotated');
  }
}

// Variáveis globais para controle da busca
let searchTimeout;
let currentSearchQuery = '';

// Carregar equipamentos disponíveis
document.addEventListener('DOMContentLoaded', function() {
  // Definir data atual como padrão para o período de faturamento
  const today = new Date().toISOString().split('T')[0];
  document.querySelector('input[name="billing_period[start_date]"]').value = today;
  
  // Configurar busca
  setupSearch();
});

function setupSearch() {
  const searchInput = document.getElementById('equipment-search');
  const searchClear = document.getElementById('search-clear');
  
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const query = this.value.trim();
      currentSearchQuery = query;
      
      // Limpar timeout anterior
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
      
      // Mostrar/esconder botão de limpar
      if (query.length > 0) {
        searchClear.style.display = 'block';
      } else {
        searchClear.style.display = 'none';
      }
      
      // Debounce da busca (500ms)
      searchTimeout = setTimeout(() => {
        searchEquipment(query);
      }, 500);
    });
    
    // Limpar busca
    searchClear.addEventListener('click', function() {
      searchInput.value = '';
      currentSearchQuery = '';
      searchClear.style.display = 'none';
      hideResults();
    });
  }
}

function loadAvailableEquipment() {
  // Esta função não é mais usada, mas mantida para compatibilidade
  searchEquipment('');
}

function searchEquipment(query) {
  if (query.length === 0) {
    // Se não há query, esconder os resultados
    hideResults();
    return;
  }
  
  if (query.length === 1) {
    // Mostrar mensagem para digitar mais caracteres
    showTypeMore();
    return;
  }
  
  showLoading();
  
  const url = `/equipments/search_available?query=${encodeURIComponent(query)}`;
  
  fetch(url)
    .then(response => response.json())
    .then(data => {
      displayEquipmentResults(data.equipments, query);
    })
    .catch(error => {
      console.error('Erro ao buscar equipamentos:', error);
      showError('Erro ao buscar equipamentos. Tente novamente.');
    });
}

function displayEquipmentResults(equipments, searchQuery = '') {
  const grid = document.getElementById('equipment-grid');
  const noResults = document.getElementById('no-results');
  
  if (!grid) return;
  
  // Limpar grid
  grid.innerHTML = '';
  
  if (equipments.length === 0) {
    if (searchQuery) {
      // Mostrar mensagem de "nenhum resultado encontrado"
      grid.style.display = 'none';
      noResults.style.display = 'block';
    } else {
      // Esconder tudo se não há query
      hideResults();
    }
    return;
  }
  
  // Mostrar resultados
  grid.style.display = 'block';
  noResults.style.display = 'none';
  
  equipments.forEach(equipment => {
    const item = createEquipmentItem(equipment);
    grid.appendChild(item);
  });
}

function showLoading() {
  const grid = document.getElementById('equipment-grid');
  const noResults = document.getElementById('no-results');
  const typeMore = document.getElementById('type-more');
  
  if (grid) {
    grid.style.display = 'block';
    grid.innerHTML = '<div class="loading-message"><i class="fas fa-spinner fa-spin"></i> Buscando equipamentos...</div>';
  }
  
  if (noResults) {
    noResults.style.display = 'none';
  }
  
  if (typeMore) {
    typeMore.style.display = 'none';
  }
}

function hideResults() {
  const grid = document.getElementById('equipment-grid');
  const noResults = document.getElementById('no-results');
  const typeMore = document.getElementById('type-more');
  
  if (grid) {
    grid.style.display = 'none';
  }
  
  if (noResults) {
    noResults.style.display = 'none';
  }
  
  if (typeMore) {
    typeMore.style.display = 'none';
  }
}

function showTypeMore() {
  const grid = document.getElementById('equipment-grid');
  const noResults = document.getElementById('no-results');
  const typeMore = document.getElementById('type-more');
  
  if (grid) {
    grid.style.display = 'none';
  }
  
  if (noResults) {
    noResults.style.display = 'none';
  }
  
  if (typeMore) {
    typeMore.style.display = 'block';
  }
}

function showError(message) {
  const grid = document.getElementById('equipment-grid');
  
  if (grid) {
    grid.style.display = 'block';
    grid.innerHTML = `<div class="error-message">${message}</div>`;
  }
}

function createEquipmentItem(equipment) {
  const item = document.createElement('div');
  item.className = 'equipment-item';
  item.innerHTML = `
    <label style="display: flex; align-items: center; cursor: pointer;">
      <input type="checkbox" name="equipment_ids[]" value="${equipment.id}" style="margin-right: 8px;">
      <div>
        <div class="equipment-name">${equipment.display_name}</div>
        <div class="equipment-details">${equipment.equipment_type_name} • ${equipment.location || 'Localização não informada'}</div>
      </div>
    </label>
  `;
  
  item.addEventListener('click', function(e) {
    if (e.target.type !== 'checkbox') {
      const checkbox = item.querySelector('input[type="checkbox"]');
      checkbox.checked = !checkbox.checked;
    }
    
    if (item.querySelector('input[type="checkbox"]').checked) {
      item.classList.add('selected');
    } else {
      item.classList.remove('selected');
    }
  });
  
  return item;
}
</script>
